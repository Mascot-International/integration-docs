<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Request Integration - Mascot</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
  header { display: flex; align-items: center; margin-bottom: 20px; }
  header img { height: 60px; margin-right: 15px; }
  h1 { margin: 0; }
  form { background: #fff; padding: 20px; border-radius: 8px; max-width: 600px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
  label { display: block; margin-top: 15px; font-weight: bold; }
  select, input, textarea { width: 100%; padding: 8px; margin-top: 5px; border-radius: 6px; border: 1px solid #ccc; }
  .checkbox-group { margin-top: 10px; }
  .checkbox-group div { display: flex; align-items: center; justify-content: space-between; padding: 6px 10px; background: #f5f5f5; border-radius: 6px; margin-top: 4px; }
  .checkbox-group label { margin: 0; flex: 1; }
  .checkbox-group input[type="checkbox"] { flex-shrink: 0; transform: scale(1.2); margin-left: 10px; }
  .buttons { margin-top: 20px; display: flex; justify-content: space-between; align-items: center; }
  .cancel-btn { background: #aaa; color: #fff; border-radius: 6px; padding: 12px 20px; cursor: pointer; border: none; }
  .cancel-btn:hover { background: #888; }
  button[type="submit"] { background: #339af0; color: #fff; border-radius: 6px; padding: 12px 20px; cursor: pointer; border: none; }
  button[type="submit"]:hover { background: #1c7ed6; }
  .error { color: red; margin-top: 5px; }
  .success { color: green; margin-top: 10px; }
</style>
<script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>

<header>
  <img src="images/mascot-logo.png" alt="Mascot Logo">
  <h1>Mascot Request Integration</h1>
</header>

<form id="integrationForm">
  <label for="formatType">Format Type</label>
  <select id="formatType" name="formatType" required>
    <option value="">-- Select Format --</option>
  </select>

  <label>Message Types</label>
  <div id="messageTypes" class="checkbox-group"></div>

  <label for="connectionType">Connection Type</label>
<select id="connectionType" disabled>
  <option value="">-- Select Connection --</option>
</select>
  <div id="connectionFields"></div>
  
  <label for="name">Your Name</label>
  <input type="text" id="name" name="name" required>

  <label for="company">Company</label>
  <input type="text" id="company" name="company" required>

  <label for="email">Email</label>
  <input type="email" id="email" name="email" required>

  <label for="notes">Notes (optional)</label>
  <textarea id="notes" name="notes" rows="4"></textarea>

  <div class="g-recaptcha" data-sitekey="6Lf3nK4rAAAAACTVh8pHOhpShI8XK8ZZdg7mdwgJ"></div>

  <div class="buttons">
    <button type="button" class="cancel-btn" onclick="window.location.href='https://mascot-international.github.io/integration-docs/'">Cancel Request</button>
    <button type="submit">Submit Request</button>
  </div>
  
  <div id="responseMessage"></div>
</form>

<script>
let catalogData = {};

// ---------- Load catalog ----------
fetch('catalog.json')
  .then(res => res.json())
  .then(data => {
    catalogData = data;
    const formatSelect = document.getElementById('formatType');
    data.categories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat.name;
      option.textContent = cat.name;
      formatSelect.appendChild(option);
    });
  });

// ---------- Format → Message Types ----------
document.getElementById('formatType').addEventListener('change', function () {
  const selected = this.value;
  const msgContainer = document.getElementById('messageTypes');
  msgContainer.innerHTML = '';
  document.getElementById('connectionType').innerHTML =
    '<option value="">-- Select Connection --</option>';
  document.getElementById('connectionType').disabled = true;
  document.getElementById('connectionFields').innerHTML = '';

  if (!selected) return;

  const category = catalogData.categories.find(c => c.name === selected);
  category.formats.forEach(fmt => {
    const div = document.createElement('div');
    div.innerHTML = `
      <label>${fmt.name}</label>
      <input type="checkbox" name="messageTypes" value="${fmt.name}">
    `;
    msgContainer.appendChild(div);
  });
});

// ---------- Message Types → Connection Types ----------
document.getElementById('messageTypes').addEventListener('change', () => {
  const format = document.getElementById('formatType').value;
  const checked = [...document.querySelectorAll('input[name="messageTypes"]:checked')]
    .map(c => c.value);

  const select = document.getElementById('connectionType');
  select.innerHTML = '<option value="">-- Select Connection --</option>';
  select.disabled = true;
  document.getElementById('connectionFields').innerHTML = '';

  if (!format || checked.length === 0) return;

  const category = catalogData.categories.find(c => c.name === format);
  const connections = new Set();

  category.formats
    .filter(f => checked.includes(f.name))
    .forEach(f => f.connections.forEach(c => connections.add(c)));

  connections.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    select.appendChild(opt);
  });

  select.disabled = false;
});

// ---------- Connection → Dynamic Fields ----------
document.getElementById('connectionType').addEventListener('change', function () {
  const container = document.getElementById('connectionFields');
  container.innerHTML = '';

  switch (this.value) {
    case 'Peppol-Network':
      container.innerHTML = `
        <label>Peppol SchemeID Prefix (4 characters)</label>
        <input id="peppolPrefix" maxlength="4" required>

        <label>Peppol Unique Participant ID </label>
        <input id="peppolOrg" required>
      `;
      break;

    case 'SFTP':
      container.innerHTML = `
        <label>Unique ID / GLN / EDI number</label>
        <input id="customerId" required>

        <label>Whitelisting of IP address(es)</label>
        <input id="whitelistIp">
      `;
      break;

    case 'EMAIL':
      container.innerHTML = `
        <label>Receiver Email</label>
        <input id="customerId" type="email" required>
      `;
      break;

    case 'Nemhandel':
      container.innerHTML = `
        <label>Danish CVR or GLN number</label>
        <input id="customerId" required>
      `;
      break;

    case 'HTTPS':
      container.innerHTML = `
        <label>API Client Identifier</label>
        <input id="customerId" required>
      `;
      break;
  }
});

// ---------- Submit ----------
document.getElementById('integrationForm').addEventListener('submit', function (e) {
  e.preventDefault();

  const formatType = formatTypeEl.value;
  const messages = [...document.querySelectorAll('input[name="messageTypes"]:checked')]
    .map(c => c.value);
  const connection = document.getElementById('connectionType').value;

  const name = nameEl.value;
  const company = companyEl.value;
  const email = emailEl.value;
  const notes = notesEl.value;
  const recaptcha = grecaptcha.getResponse();

  let customfield_10222 = null;
  let customfield_10299 = null;

  if (!formatType || messages.length === 0 || !connection) {
    responseMessage.textContent = 'Please select format, message type, and connection.';
    responseMessage.className = 'error';
    return;
  }

  if (connection === 'Peppol-Network') {
    customfield_10222 =
      document.getElementById('peppolPrefix').value +
      ':' +
      document.getElementById('peppolOrg').value;
  }

  if (connection === 'SFTP') {
    customfield_10222 = document.getElementById('customerId').value;
    customfield_10299 = document.getElementById('whitelistIp').value;
  }

  if (['EMAIL', 'Nemhandel', 'HTTPS'].includes(connection)) {
    customfield_10222 = document.getElementById('customerId').value;
  }

  fetch('https://integration-docs-olive.vercel.app/api/jira-create', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      formatType,
      messages,
      connection,
      customfield_10222,
      customfield_10299,
      name,
      company,
      email,
      notes,
      recaptcha
    })
  })
    .then(res => res.json())
    .then(resp => {
      responseMessage.textContent = resp.success
        ? 'Request submitted successfully!'
        : resp.error || 'Submission failed.';
      responseMessage.className = resp.success ? 'success' : 'error';
      if (resp.success) this.reset();
      grecaptcha.reset();
    })
    .catch(() => {
      responseMessage.textContent = 'Submission failed.';
      responseMessage.className = 'error';
    });
});
</script>

</body>
</html>
