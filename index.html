<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mascot Integration Catalog</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  header { display: flex; align-items: center; margin-bottom: 20px; }
  header img { height: 60px; margin-right: 15px; }
  h1 { margin: 0; }
  .category { margin-bottom: 30px; }
  .format { margin-left: 20px; margin-bottom: 5px; }
  .badge { display: inline-block; padding: 3px 6px; margin-right: 5px; border-radius: 4px; background-color: #eee; font-size: 0.9em; }
  .form-section { margin-top: 40px; padding: 20px; border: 1px solid #ccc; border-radius: 10px; max-width: 600px; }
  label { display: block; margin-top: 10px; }
  select, input { width: 100%; padding: 6px; margin-top: 5px; }
  button { margin-top: 15px; padding: 10px 15px; font-size: 1em; }
</style>
</head>
<body>

<header>
  <img src="logo.png" alt="Mascot Logo">
  <h1>Mascot Integration Catalog</h1>
</header>

<div id="catalog"></div>

<div class="form-section">
  <h2>Request Integration</h2>
  <form id="integrationForm">
    <label>Company Name
      <input type="text" name="companyName" required>
    </label>
    <label>Existing or New Mascot Customer?
      <select name="customerType" required>
        <option value="Existing">Existing</option>
        <option value="New">New</option>
      </select>
    </label>
    <label>Integration Type
      <select name="integrationType" id="integrationType" required>
        <option value="">--Select--</option>
      </select>
    </label>
    <label>Formats
      <select name="format" id="formatSelect" required multiple></select>
    </label>
    <label>Connection Type
      <select name="connectionType" id="connectionSelect" required></select>
    </label>
    <label>Technical Contact (Name + Email)
      <input type="text" name="technicalContact" required>
    </label>
    <label>Proposed Go-Live Date
      <input type="date" name="goLiveDate" required>
    </label>
    <!-- Simple front-end CAPTCHA -->
    <label>What is 3 + 4? (Anti-bot)
      <input type="text" id="captcha" required>
    </label>
    <button type="submit">Submit Request</button>
    <p id="formMessage" style="color:red;"></p>
  </form>
</div>

<script>
let catalogData = {};
let requestCounts = {}; // IP-like tracking (front-end only)

// Load catalog.json
fetch('catalog.json')
  .then(res => res.json())
  .then(data => {
    catalogData = data;
    renderCatalog(data);
    populateIntegrationTypes(data);
  });

function renderCatalog(data) {
  const container = document.getElementById('catalog');
  data.categories.forEach(cat => {
    const catDiv = document.createElement('div');
    catDiv.className = 'category';
    const catTitle = document.createElement('h2');
    catTitle.textContent = cat.name;
    catDiv.appendChild(catTitle);

    cat.formats.forEach(fmt => {
      const fmtDiv = document.createElement('div');
      fmtDiv.className = 'format';
      fmtDiv.innerHTML = `<strong>${fmt.name}</strong> - <a href="${fmt.docUrl}" target="_blank">${fmt.docUrl}</a>`;
      fmt.connections.forEach(conn => {
        const badge = document.createElement('span');
        badge.className = 'badge';
        badge.textContent = conn;
        fmtDiv.appendChild(badge);
      });
      catDiv.appendChild(fmtDiv);
    });
    container.appendChild(catDiv);
  });
}

// Populate integration types dropdown
function populateIntegrationTypes(data) {
  const select = document.getElementById('integrationType');
  data.categories.forEach(cat => {
    const option = document.createElement('option');
    option.value = cat.name;
    option.textContent = cat.name;
    select.appendChild(option);
  });
}

// Smart form logic
const integrationTypeEl = document.getElementById('integrationType');
const formatSelectEl = document.getElementById('formatSelect');
const connectionSelectEl = document.getElementById('connectionSelect');

integrationTypeEl.addEventListener('change', () => {
  const selectedType = integrationTypeEl.value;
  formatSelectEl.innerHTML = '';
  connectionSelectEl.innerHTML = '';

  const cat = catalogData.categories.find(c => c.name === selectedType);
  if (!cat) return;

  cat.formats.forEach(fmt => {
    const opt = document.createElement('option');
    opt.value = fmt.name;
    opt.textContent = fmt.name;
    formatSelectEl.appendChild(opt);
  });
});

formatSelectEl.addEventListener('change', () => {
  const selectedType = integrationTypeEl.value;
  const selectedFormats = Array.from(formatSelectEl.selectedOptions).map(o => o.value);

  const cat = catalogData.categories.find(c => c.name === selectedType);
  if (!cat) return;

  // Determine connections allowed: intersection of all selected formats
  let allowedConnections = null;
  selectedFormats.forEach(fmtName => {
    const fmt = cat.formats.find(f => f.name === fmtName);
    if (!allowedConnections) allowedConnections = [...fmt.connections];
    else allowedConnections = allowedConnections.filter(c => fmt.connections.includes(c));
  });

  // Populate connection dropdown
  connectionSelectEl.innerHTML = '';
  allowedConnections.forEach(conn => {
    const opt = document.createElement('option');
    opt.value = conn;
    opt.textContent = conn;
    connectionSelectEl.appendChild(opt);
  });
});

// Simple front-end anti-bot limit & CAPTCHA
document.getElementById('integrationForm').addEventListener('submit', e => {
  e.preventDefault();
  const captchaVal = document.getElementById('captcha').value.trim();
  if (captchaVal !== '7') {
    document.getElementById('formMessage').textContent = 'CAPTCHA incorrect!';
    return;
  }

  const formData = new FormData(e.target);
  const requestKey = formData.get('companyName').toLowerCase(); // rough "IP-like" key
  if (!requestCounts[requestKey]) requestCounts[requestKey] = 0;
  requestCounts[requestKey]++;
  if (requestCounts[requestKey] > 3) {
    document.getElementById('formMessage').textContent = 'Too many requests from this company!';
    return;
  }

  // TODO: Send to Lobster/Jira API endpoint
  console.log('Form submitted:', Object.fromEntries(formData.entries()));
  alert('Integration request submitted!');
  e.target.reset();
  formatSelectEl.innerHTML = '';
  connectionSelectEl.innerHTML = '';
});
</script>

</body>
</html>
