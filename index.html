<style>
  .badge {
    display: inline-block;
    padding: 3px 8px;
    margin: 3px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
    color: white;
    cursor: pointer;
    transition: transform 0.1s ease-in-out;
  }
  .badge:hover { transform: scale(1.1); opacity: 0.9; }

  .badge-sftp { background-color: #00796b; }
  .badge-ftp { background-color: #0288d1; }
  .badge-email { background-color: #6a1b9a; }
  .badge-http { background-color: #e65100; }
  .badge-tbd { background-color: #757575; }

  .active-badge { border: 2px solid #000; }
</style>

<script>
  let catalogData = [];
  let activeFilter = null; // holds currently selected connection filter

  async function loadCatalog() {
    const response = await fetch("catalog.json");
    catalogData = await response.json();
    renderCatalog(catalogData.categories);
  }

  function renderCatalog(categories) {
    const container = document.getElementById("catalog");
    container.innerHTML = "";

    categories.forEach(category => {
      const details = document.createElement("details");
      const summary = document.createElement("summary");
      summary.textContent = category.name;
      details.appendChild(summary);

      // Formats
      category.formats.forEach(f => {
        const formatEl = document.createElement("div");
        formatEl.className = "format";

        let html = `<strong>${f.name}</strong> - <a href="${f.docUrl}" target="_blank">${f.docUrl}</a>`;
        if (f.notes) {
          html += ` <span class="notes">(${f.notes})</span>`;
        }

        formatEl.innerHTML = html;
        details.appendChild(formatEl);
      });

      // Connections as clickable badges
      if (category.connections && category.connections.length > 0) {
        const connEl = document.createElement("div");
        connEl.className = "format";

        let html = `<strong>Connections:</strong> `;
        category.connections.forEach(conn => {
          let cssClass = "badge";
          if (conn.toLowerCase().includes("sftp")) cssClass += " badge-sftp";
          else if (conn.toLowerCase().includes("ftp")) cssClass += " badge-ftp";
          else if (conn.toLowerCase().includes("email")) cssClass += " badge-email";
          else if (conn.toLowerCase().includes("http")) cssClass += " badge-http";
          else cssClass += " badge-tbd";

          html += `<span class="${cssClass}" onclick="filterByConnection('${conn}')">${conn}</span>`;
        });

        connEl.innerHTML = html;
        details.appendChild(connEl);
      }

      container.appendChild(details);
    });
  }

  function filterByConnection(conn) {
    if (activeFilter === conn) {
      // toggle off filter
      activeFilter = null;
      renderCatalog(catalogData.categories);
      return;
    }
    activeFilter = conn;

    const filtered = catalogData.categories.filter(cat =>
      cat.connections && cat.connections.includes(conn)
    );
    renderCatalog(filtered);

    // Mark active badges
    const badges = document.querySelectorAll(".badge");
    badges.forEach(b => {
      if (b.textContent === conn) {
        b.classList.add("active-badge");
      }
    });
  }

  document.getElementById("searchBar").addEventListener("input", function() {
    const query = this.value.toLowerCase();
    const filtered = catalogData.categories.map(cat => {
      const matchedFormats = cat.formats.filter(f =>
        f.name.toLowerCase().includes(query) ||
        (f.notes && f.notes.toLowerCase().includes(query)) ||
        cat.name.toLowerCase().includes(query)
      );
      return matchedFormats.length > 0 ? { ...cat, formats: matchedFormats, connections: cat.connections } : null;
    }).filter(Boolean);

    renderCatalog(filtered);
  });

  loadCatalog();
</script>
